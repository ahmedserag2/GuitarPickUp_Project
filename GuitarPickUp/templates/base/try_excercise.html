{% extends 'base.html' %}

{% block head %}
<title>Home</title>
{% endblock %}

{% block body %}

<div class="site-mobile-menu site-navbar-target">
    <div class="site-mobile-menu-header">
        <div class="site-mobile-menu-close mt-3">
            <span class="icon-close2 js-menu-toggle"></span>
        </div>
    </div>
    <div class="site-mobile-menu-body"></div>
</div>

<!--------------------------Header section ----------------------------------->

<header class="site-navbar py-4 js-sticky-header site-navbar-target" role="banner">

    <div class="container-fluid">
        <div class="d-flex align-items-center">
            <div class="site-logo mr-auto w-25"><a href="index.html">Guitar<a style="color: #d70303;"
                        href="index.html">PickUp</a></a></div>

            <div class="mx-auto text-center">
                <nav class="site-navigation position-relative text-right" role="navigation">
                    <ul class="site-menu main-menu js-clone-nav mx-auto d-none d-lg-block  m-0 p-0">
                        <li><a href="/" class="nav-link">Home</a></li>
                        <li><a href="/" class="nav-link">About Us</a></li>
                        <li><a href="/" class="nav-link">Programs</a></li>
                        <li><a href="/" class="nav-link">Contact Us</a></li>
                    </ul>
                </nav>
            </div>

            <div class="ml-auto w-25">
                <nav class="site-navigation position-relative text-right" role="navigation">
                    <ul class="site-menu main-menu site-menu-dark js-clone-nav mr-auto d-none d-lg-block m-0 p-0">
                        {% if request.user.is_authenticated%}
                        <p>Welcome {{request.user}}</p>
                        <li class="cta"><a href="{% url 'logout' %}" class="nav-link"><span>Logout</span></a></li>
                        {% else %}
                        <li class="cta"><a href="{% url 'login' %}" class="nav-link"><span>Login</span></a></li>
                        {% endif %}
                    </ul>
                </nav>
                <a href="#"
                    class="d-inline-block d-lg-none site-menu-toggle js-menu-toggle text-black float-right"><span
                        class="icon-menu h3"></span></a>
            </div>
        </div>
    </div>

</header>

<!--------------------------Home section ----------------------------------->

<div class="intro-section" id="programs-section">
    <div class="slide-1" style="background-image: url('static/images/main.jpeg');" data-stellar-background-ratio="0.5">
        <h1 data-aos="fade-up" data-aos-delay="100" class="text-center" style="position: absolute; text-align: center; width:100%; top:20%">Exercise 1</h1>

        <div class="container">

            <div class="row align-items-center">
                
                <div class="col-6"><video width="450" height="350" controls style="object-fit: fill;"><source src="/static/images/video1.mp4" type="video/mp4"></video></div>
                <div class="col-6">
                    <div class="container">
                        <video class="input_video" style="display:none"></video>
                        <canvas class="output_canvas" width="450" height="350"></canvas>
                      </div>
                </div>
            
            </div>
            
            <script type="module">
                
                const videoElement = document.getElementsByClassName('input_video')[0];
                const canvasElement = document.getElementsByClassName('output_canvas')[0];
                const canvasCtx = canvasElement.getContext('2d');
                var indexFinger = document.getElementById("index");
                var middleFinger = document.getElementById("middle");
                var ringFinger = document.getElementById("ring");
                var pinkyFinger = document.getElementById("pinky");
                function onResults(results) {
                  canvasCtx.save();
                  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                  canvasCtx.drawImage(
                      results.image, 0, 0, canvasElement.width, canvasElement.height);
                  if (results.multiHandLandmarks) {
                      var left_hand;
                      var right_hand;
                      for (var i = 0; i < 2; i++) {
                          if (results.multiHandedness[i]) {
                            if (results.multiHandedness[i]['label'] == "Left") {
                                left_hand = results.multiHandLandmarks[i];
                            } else if (results.multiHandedness[i]['label'] == "Right"){
                                right_hand = results.multiHandLandmarks[i];
                            }
                        }
                      }

                    // identify an element to observe
                    let elementToObserve = document.getElementById('noteID');
                    
                    // create a new instance of 'MutationObserver' named 'observer', 
                    // passing it a callback function
                    let note_changed = document.getElementById('noteID').innerHTML;   
                    let observer = new MutationObserver(function (mutationsList, observer) {
                        //console.log(mutationsList);
                        //console.log(note_changed);
                        //console.log(document.getElementById('noteID').innerHTML)
                        //console.log(note_changed != document.getElementById('noteID').innerHTML);
                        if(note_changed != document.getElementById('noteID').innerHTML)
                        {
                            note_changed = document.getElementById('noteID').innerHTML;
                            let index_class = document.getElementById('index').innerHTML;
                            let middle_class = document.getElementById('middle').innerHTML;
                            let ring_class = document.getElementById('ring').innerHTML;
                            let pinky_class = document.getElementById('pinky').innerHTML;
                            console.log('noticable change');
                            //console.log(note_changed);
                            /*
                            $.ajax({
                                url: '/record_feedback',
                                data: {
                                    'index_class': index_class,
                                    'middle_class':middle_class,
                                    'ring_class':ring_class,
                                    'pinky_class':pinky_class,
                                    'note_played': note_changed,

                                },
                                dataType: 'json',
                                success: function (data) {
                                    console.log('success');

                                }
                            });*/
                            //save classes and note 
                        }
                        
                        
                        
                    });

                    // call 'observe' on that MutationObserver instance, 
                    // passing it the element to observe, and the options object
                    observer.observe(elementToObserve, { characterData: true, childList: true, attributes: false });

                    $.ajax({
                        url: '/validate_hands',
                        data: {
                            'right_hand': JSON.stringify(right_hand),
                        },
                        dataType: 'json',
                        success: function (data) {
                            //console.log(data);
                            if (data["index"]) {
                                $('#index').text(data['index']);
                                $('#ring').text(data['ring']);
                                $('#middle').text(data['middle']);
                                $('#pinky').text(data['pinky']);
                                //console.log(data);
                                //$('#note').text(data['note']);
                            }
                        }
                    });
                    for (const landmarks of results.multiHandLandmarks) {
                      drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS,
                                     {color: '#00FF00', lineWidth: 5});
                      drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});
                    }
                  }
                  canvasCtx.restore();
                }
                
                const hands = new Hands({locateFile: (file) => {
                  return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }});
                hands.setOptions({
                  maxNumHands: 2,
                  modelComplexity: 1,
                  minDetectionConfidence: 0.5,
                  minTrackingConfidence: 0.5
                });
                hands.onResults(onResults);
                
                const camera = new Camera(videoElement, {
                  onFrame: async () => {
                    await hands.send({image: videoElement});
                  },
                  width: 450,
                  height: 350
                });
                camera.start();
                
                    
                </script>
        </div>
        <div style="position: absolute; text-align: center; width:100%; bottom:2%; background-color: white; color: black; width: 300px; height: 240px; margin-left: auto; margin-right: auto; left: 0; right: 0;">
            Feedback
            <hr>
            <dl>
                <dt>note</dt>
                <!--<dd id="note">asd</dd>-->
                <dd id="noteID">A</dd>
                <dt>Index</dt>
                <dd id="index">0.2</dd>
                <dt>Middle</dt>
                <dd id="middle">0.2</dd>
                <dt>Ring</dt>
                <dd id="ring">0.2</dd>
                <dt>Pinky</dt>
                <dd id="pinky">0.2</dd>
                
                
                
            
            </dl>        
        </div>

            

        <div style="position: absolute; text-align: center; width:100%; bottom:25%"><button class="btn btn-primary py-3 px-5 btn-pill exercise">Try now</button></div>

    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script src="https://cdn.jsdelivr.net/npm/aubiojs"></script>
<script src="/static/js/tuner.js"></script>
<script src="/static/js/meter.js"></script>
<script src="/static/js/notes.js"></script>
<script src="/static/js/app.js"></script>

<!--------------------------Contact us section ----------------------------------->

<!--------------------------Footer section ----------------------------------->
{% endblock %}
